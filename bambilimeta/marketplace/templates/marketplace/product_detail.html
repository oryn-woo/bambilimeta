<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{{ product.name }} — Campus Deals</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --detail-radius: 1rem;
      --detail-media-h-sm: 320px;
      --detail-media-h-md: 420px;
      --thumb-gap: .5rem;
    }

    /* Page chrome */
    body{ background: #f7f8fa; }

    /* Breadcrumb + back */
    .crumbs a{ text-decoration:none; }
    .crumbs .sep{ color:#adb5bd; }

    /* Glow wrapper per product */
    .detail-wrapper{
      position: relative;
      border-radius: 1.25rem;
      padding: 1rem;
      background: #fff;
      z-index: 0;
    }
    .detail-wrapper::before{
      content:"";
      position:absolute;
      inset:-12px;
      border-radius: 1.5rem;
      background: var(--glow-bg, transparent);
      box-shadow: 0 0 3rem var(--glow, rgba(0,0,0,0));
      z-index:-1;
    }
    /* Category themes */
    .category--fashion     { --glow:#d6338430; --glow-bg:#fff7fb; }
    .category--electronics { --glow:#20c99730; --glow-bg:#f7f9ff; }
    .category--edibles     { --glow:#19875430; --glow-bg:#f8fff7; }
    .category--skills      { --glow:#0d6efd30; --glow-bg:#f7fbff; }

    /* Gallery */
    .media-card{
      border-radius: var(--detail-radius);
      background: #fff;
      border:1px solid rgba(0,0,0,0.06);
    }
    .media-card .carousel-item img{
      width:100%;
      height: var(--detail-media-h-sm);
      object-fit: cover;
      border-radius: .75rem;
    }
    @media (min-width:768px){
      .media-card .carousel-item img{ height: var(--detail-media-h-md); }
    }

    /* Thumbs: ALWAYS VERTICAL */
    .thumbs{
      display:flex;
      flex-direction: column; /* no breakpoint switch */
      gap: var(--thumb-gap);
      overflow-y:auto;
      overflow-x:hidden;
      max-height: var(--detail-media-h-sm);
      padding-right: 2px;
    }
    @media (min-width:768px){
      .thumbs{ max-height: var(--detail-media-h-md); }
    }
    .thumbs img{
      width:100%;
      aspect-ratio:1/1;
      object-fit:cover;
      border-radius:.5rem;
      border:1px solid rgba(0,0,0,0.06);
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s;
    }
    .thumbs img:hover{ transform: scale(1.02); }
    .thumbs img.active{
      border-color: #0d6efd;
      box-shadow: 0 0 0 .2rem rgba(13,110,253,.15);
    }

    /* Summary card */
    .summary-card{
      position: sticky;
      top: 1rem;
      border-radius: var(--detail-radius);
      background: #fff;
      border:1px solid rgba(0,0,0,0.06);
    }
    .price .old{ text-decoration: line-through; color:#adb5bd; }
    .price .deal{ color:#d63384; font-weight:700; }
    .price .save{ color:#198754; font-weight:600; }

    .swatch{
      width:28px;height:28px;border-radius:50%;
      border:1px solid rgba(0,0,0,.1);
      cursor:pointer;
      display:inline-block;
      vertical-align:middle;
    }
    .swatch.active{ outline: 2px solid #0d6efd; outline-offset: 2px; }

    .qty input[type="number"]{
      width:72px; text-align:center;
    }

    /* Tabs */
    .nav-scroller{
      position: sticky;
      top: 0; z-index: 1;
      background: linear-gradient(#fff,#fff);
    }
    .tab-pane img{ max-width:100%; height:auto; }

    /* Sticky mobile bar */
    .sticky-cta{
      position: sticky;
      bottom: 0;
      background: rgba(255,255,255,.98);
      backdrop-filter: blur(6px);
      border-top:1px solid rgba(0,0,0,.06);
      padding:.75rem;
      display:none;
    }
    @media (max-width: 991.98px){
      .sticky-cta{ display:block; }
      .summary-card{ position: static; } /* avoid double stickiness on mobile */
    }

    /* Related products */
    .related .section-title{ font-weight:600; }
  </style>
</head>
<body>

  <header class="container-xxl py-3">
    <div class="d-flex align-items-center gap-3">
      <a href="{% url 'market:home' %}" class="btn btn-outline-secondary btn-sm">&larr; Back</a>
      <nav class="crumbs small text-secondary" aria-label="breadcrumb">
        <a href="{% url 'market:home' %}" class="text-secondary">Home</a>
        <span class="sep mx-1">/</span>
        <a href="{% url 'market:home' %}" class="text-secondary">Products</a>
        <span class="sep mx-1">/</span>
        <span class="text-body">{{ product.name }}</span>
      </nav>
    </div>
  </header>

  <main class="container-xxl pb-5">
    <section class="detail-wrapper category--{{ product.category.slug|default:'skills' }}">
      <div class="row g-3">
        <!-- MEDIA -->
        <div class="col-12 col-lg-7">
          <article class="media-card p-3">
            <div class="row g-3">
              <!-- Thumbs (always vertical) -->
              <div class="col-3">
                <div class="thumbs" id="thumbs">
                  {% for image in product.images.all %}
                    <img
                      src="{{ image.image.url }}"
                      alt="{{ product.name }} thumbnail {{ forloop.counter }}"
                      data-target="#prodDetailCarousel-{{ product.id }}"
                      data-index="{{ forloop.counter0 }}"
                      class="{% if forloop.first %}active{% endif %}">
                  {% empty %}
                    <img src="#" alt="No image" data-target="#prodDetailCarousel-{{ product.id }}" data-index="0" class="active">
                  {% endfor %}
                </div>
              </div>
              <!-- Main carousel -->
              <div class="col-9">
                <div id="prodDetailCarousel-{{ product.id }}" class="carousel slide" data-bs-ride="false" aria-label="Image gallery of {{ product.name }}">
                  <div class="carousel-inner">
                    {% for image in product.images.all %}
                      <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <img src="{{ image.image.url }}" alt="{{ product.name }} image {{ forloop.counter }}">
                      </div>
                    {% empty %}
                      <div class="carousel-item active">
                        <img src="#" alt="{{ product.name }}">
                      </div>
                    {% endfor %}
                  </div>
                  <button class="carousel-control-prev" type="button" data-bs-target="#prodDetailCarousel-{{ product.id }}" data-bs-slide="prev" aria-label="Previous image">
                    <span class="carousel-control-prev-icon"></span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#prodDetailCarousel-{{ product.id }}" data-bs-slide="next" aria-label="Next image">
                    <span class="carousel-control-next-icon"></span>
                  </button>
                </div>
                <!-- Optional: caption under image -->
                <div class="mt-2 small text-warning">
                  Use arrows or tap thumbnails to switch images.
                </div>
              </div>
            </div>
          </article>
        </div>

        <!-- SUMMARY -->
        <div class="col-12 col-lg-5">
          <aside class="summary-card p-4">
            <h1 class="h4 mb-1">{{ product.name }}</h1>
            <div class="d-flex align-items-center gap-2 mb-2">
              <div class="text-warning" aria-label="{{ product.rating }} out of 5">
                {% for i in "12345" %}
                  {% if forloop.counter <= product.stock|default:0 %}★{% else %}☆{% endif %}
                {% endfor %}
              </div>
              <span class="small text-secondary">({{ product.review_count|default:0 }} reviews)</span>
            </div>

            <div class="mb-3 price">
              {% if product.discount_price %}
                <div class="fs-4 deal">{{ product.discount_price  CFA</div>
                <div class="small">
                  <span class="old">{{ product.price  CFA</span>
                  <span class="ms-2 save">
                    Save {# {{ product.price|add:-product.discount_price }} #} CFA
                  </span>
                </div>
              {% else %}
                <div class="fs-4 fw-bold">{{ product.price }} CFA</div>
              {% endif %}
            </div>

            <div class="mb-3">
              {% for tag in product.tags.all %}
                <span class="badge rounded-pill text-bg-light border">{{ tag.name }}</span>
              {% empty %}
                <span class="badge text-bg-light border">Student deal</span>
              {% endfor %}
            </div>

            <!-- Variants -->
            {% if product.colors %}
              <div class="mb-3">
                <label class="form-label small">Color</label>
                <div class="d-flex align-items-center gap-2">
                  {% for color in product.colors %}
                    <button type="button" class="swatch" title="{{ color.name }}"
                            style="background: {{ color.hex }};"
                            data-variant="color" data-value="{{ color.slug }}"></button>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            {% if product.sizes %}
              <div class="mb-3">
                <label for="size" class="form-label small">Size</label>
                <select id="size" class="form-select form-select-sm" name="size">
                  {% for size in product.sizes %}
                    <option value="{{ size.slug }}">{{ size.name }}</option>
                  {% endfor %}
                </select>
              </div>
            {% endif %}

            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="qty input-group input-group-sm" style="width: 8.5rem;">
                <button class="btn btn-outline-secondary" type="button" data-qty="-1" aria-label="Decrease quantity">−</button>
                <input type="number" class="form-control" value="1" min="1" name="quantity">
                <button class="btn btn-outline-secondary" type="button" data-qty="1" aria-label="Increase quantity">+</button>
              </div>
              <div class="small text-{{ product.in_stock|yesno:'success,danger' }}">
                {% if product.in_stock %}In Stock{% else %}Out of Stock{% endif %}
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mb-3">
              <form method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <button class="btn btn-primary">
                  Add to Cart
                </button>
              </form>
              <a href="" class="btn btn-outline-primary">Buy Now</a>
              <form method="post" action="">
                {% csrf_token %}
                <button class="btn btn-outline-secondary">♡ Wishlist</button>
              </form>
            </div>

            <ul class="list-unstyled small text-secondary mb-0">
              <li>SKU: <span class="text-body">{{ product.sku|default:"—" }}</span></li>
              <li>Category: <a class="text-decoration-none" href="{% url 'market:home' %}?category={{ product.category.slug }}">{{ product.category.name }}</a></li>
              <li>Return: 7‑day easy returns</li>
              <li>Delivery: Fast campus pickup</li>
            </ul>
          </aside>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mt-4">
        <ul class="nav nav-tabs" id="detailTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#desc" type="button" role="tab">Description</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#specs" type="button" role="tab">Specs</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab">Reviews ({{ product.review_count|default:0 }})</button>
          </li>
        </ul>
        <div class="tab-content p-3 bg-white border border-top-0 rounded-bottom">
          <div class="tab-pane fade show active" id="desc" role="tabpanel">
            {{ product.description|linebreaks }}
          </div>
          <div class="tab-pane fade" id="specs" role="tabpanel">
            {% if product.specs %}
              <div class="row">
                {% for spec in product.specs %}
                  <div class="col-6 col-md-4 mb-2">
                    <div class="small text-secondary">{{ spec.name }}</div>
                    <div class="fw-semibold">{{ spec.value }}</div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-secondary mb-0">No specifications provided.</p>
            {% endif %}
          </div>
            {% if reviews %}
                  <div class="tab-pane fade" id="reviews" role="tabpanel">

                <div class="list-group">
                    <div class="row ">
                        {% for review in reviews %}
                            <div class="col-12 col-md-6 mb-3">

                                <div class="list-group-item bg-dark bg-opacity-25 border-light mb-3 rounded-3">
                                    <div class="d-flex w-100 justify-content-between mb-2">
                                        <h5 class="mb-1 text-primary"><i class="bi bi-person p-2 me-2 fs-2"></i>{{ review.author.get_full_name|default:review.author.username }}</h5>
                                        <small class="text-muted text-light">{{ review.reviewed_on|timesince }} ago</small>
                                    </div>
                                    <div class="mb-2">
                                        {% for i in "12345" %}
                                        <i class="bi bi-star{% if forloop.counter > review.rating %}-fill text-light{% else %}-fill text-warning{% endif %}"></i>
                                        {# loops over a string of length 5, and if the current it adds a gray, else it adds a gold star, eventually a rating of 3, is yellow until counter reaches 4 where it becomes gray#}
                                        {% endfor %}
                                    </div>
                                    <p class="mb-1 text-light">{{ review.comment }}</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>


                    <form class="mt-3" method="post" action="{% url 'reviews:add' product.id %}">
                      {% csrf_token %}
                      <div class="row g-2">
                        <div class="col-md-6">
                          <label class="form-label small">Your name</label>
                          <input type="text" name="author_name" class="form-control form-control-sm" required>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label small">Rating</label>
                          <select name="rating" class="form-select form-select-sm">
                            <option value="5">★★★★★</option>
                            <option value="4">★★★★☆</option>
                            <option value="3">★★★☆☆</option>
                            <option value="2">★★☆☆☆</option>
                            <option value="1">★☆☆☆☆</option>
                          </select>
                        </div>
                        <div class="col-12">
                          <label class="form-label small">Comment</label>
                          <textarea name="comment" rows="3" class="form-control" required></textarea>
                        </div>
                        <div class="col-12">
                          <button class="btn btn-primary btn-sm">Submit review</button>
                        </div>
                      </div>
                    </form>
                  </div>
            {% endif %}
            <a href="{% url 'market:product-image-edit' product.id %}">product-update</a>
            <a href="{% url 'market:product-details-edit' product.id %}">product-update</a>
        </div>
      </div>

      <!-- Related products -->
      <section class="related mt-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h6 section-title mb-0">Related products</h2>
          <a href="{% url 'market:home' %}?category={{ product.category.slug }}" class="btn btn-sm btn-outline-secondary">View all</a>
        </div>
          {% if related_products %}
                <div class="row g-3">
                  {% for p in related_products %}
                    <div class="col-12 col-md-6 col-xl-4">
                      <article class="card product-card h-100 shadow-sm category--{{ p.category.slug|default:'skills' }}">
                        <div class="card-body">
                          <div class="row g-3">
                            <div class="col-4">
                              <div class="thumbs">
                                {% for img in p.images.all|slice:":3" %}
                                  <img src="{{ img.image.url }}" alt="{{ p.name }} thumbnail {{ forloop.counter }}"
                                       data-target="#relCarousel-{{ p.id }}" data-index="{{ forloop.counter0 }}">
                                {% endfor %}
                              </div>
                            </div>
                            <div class="col-8">
                              <div id="relCarousel-{{ p.id }}" class="carousel slide" data-bs-ride="false" aria-label="Preview {{ p.name }}">
                                <div class="carousel-inner">
                                  {% for img in p.images.all|slice:":3" %}
                                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                      <img src="{{ img.image.url }}" alt="{{ p.name }} image {{ forloop.counter }}" style="height:200px;object-fit:cover;border-radius:.5rem;">
                                    </div>
                                  {% endfor %}
                                </div>
                              </div>
                              <div class="d-block mt-2 d-md-none">
                                <div class="d-flex justify-content-between">
                                  <span class="fw-semibold">{{ p.name }}</span>
                                  <span class="fw-bold text-warning">{{ p.price }} CFA</span>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="mt-3 d-flex gap-2">
                            <a class="btn btn-outline-secondary btn-sm" href="{% url 'products:detail' p.slug %}">Details</a>
                            <form method="post" action="{% url 'cart:add' p.id %}">{% csrf_token %}
                              <button class="btn btn-primary btn-sm" type="submit">Add</button>
                            </form>
                          </div>
                        </div>
                      </article>
                    </div>
                  {% endfor %}
                </div>
          {% endif %}
      </section>
    </section>

    <!-- Sticky mobile CTA -->
    <div class="sticky-cta">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          {% if product.discount_price %}
            <div class="fw-bold">{{ product.discount_price }} CFA</div>
            <div class="small text-secondary"><span class="text-decoration-line-through">{{ product.price }} CFA</span></div>
          {% else %}
            <div class="fw-bold">{{ product.price }} CFA</div>
          {% endif %}
        </div>
        <form method="post" action="{# {% url 'cart:add' product.id %} #}" class="m-0">
          {% csrf_token %}
          <input type="hidden" name="quantity" value="1">
          <button class="btn btn-primary">Add to Cart</button>
        </form>
      </div>
    </div>
  </main>

  <footer class="container-xxl py-5 text-center text-secondary small">
    © {#{{ now|"Y" }}#} Campus Deals — Designed for students.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Thumbnail -> Carousel sync (detail + related)
    document.querySelectorAll('.thumbs img').forEach(img => {
      img.addEventListener('click', (e) => {
        const el = e.currentTarget;
        const target = el.getAttribute('data-target');
        const index = parseInt(el.getAttribute('data-index'), 10);
        const carouselEl = document.querySelector(target);
        if (!carouselEl) return;
        const bsCarousel = bootstrap.Carousel.getOrCreateInstance(carouselEl);
        bsCarousel.to(index);
        // Active thumb highlight within its thumbs container
        el.closest('.thumbs')?.querySelectorAll('img').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
      });
    });

    // Quantity stepper
    document.querySelectorAll('[data-qty]').forEach(btn => {
      btn.addEventListener('click', () => {
        const delta = parseInt(btn.getAttribute('data-qty'), 10);
        const input = btn.parentElement.querySelector('input[type="number"]');
        const min = parseInt(input.min || '1', 10);
        const value = Math.max(min, parseInt(input.value || '1', 10) + delta);
        input.value = value;
        // if there is a hidden quantity in the Add-to-Cart form, sync it
        document.querySelectorAll('form[action*="cart:add"] input[name="quantity"]').forEach(h => h.value = value);
      });
    });

    // Variant swatches active state
    document.querySelectorAll('.swatch').forEach(s => {
      s.addEventListener('click', () => {
        const group = s.getAttribute('data-variant');
        document.querySelectorAll('.swatch[data-variant="'+group+'"]').forEach(x => x.classList.remove('active'));
        s.classList.add('active');
      });
    });
  </script>
</body>
</html>
